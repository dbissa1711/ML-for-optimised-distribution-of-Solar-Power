import pandas as pd
import numpy as np
from google.colab import files
import io
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import RandomForestRegressor
import matplotlib.pyplot as plt

uploaded = files.upload()
file_name = list(uploaded.keys())[0]
df = pd.read_csv(io.BytesIO(uploaded[file_name]))

df = df[['appliance_type','energy_kwh','outdoor_temp','season','household_size','time_hour','desired_temp','solar_generation']]
df['appliance_type'] = df['appliance_type'].str.strip()
df['season'] = df['season'].str.strip()

df.loc[df['appliance_type']=='Air Conditioning','energy_kwh'] /= 3.0
df.loc[df['appliance_type']=='Lights','energy_kwh'] /= 100.0

le_appliance = LabelEncoder()
le_season = LabelEncoder()
df['appliance_encoded'] = le_appliance.fit_transform(df['appliance_type'])
df['season_encoded'] = le_season.fit_transform(df['season'])

X = df[['appliance_encoded','outdoor_temp','season_encoded','household_size','time_hour','desired_temp','solar_generation']]
y = df['energy_kwh']

X_train,X_test,y_train,y_test = train_test_split(X,y,test_size=0.2,random_state=42)
rf = RandomForestRegressor(n_estimators=200,random_state=42)
rf.fit(X_train,y_train)

outdoor_temp = float(input("Outdoor Temperature (°C): "))
desired_temp = float(input("Desired Indoor Temperature (°C): "))
time_hour = int(input("Current Hour (0–23): "))
solar_gen = float(input("Available Solar Power (W): "))
season_in = input("Season: ").strip()
household = int(input("Household Size: "))

ac_on = input("Switch on AC? (yes/no): ").strip().lower() == "yes"
fan_on = input("Switch on Fan? (yes/no): ").strip().lower() == "yes"
light_on = input("Switch on Lights? (yes/no): ").strip().lower() == "yes"

def season_encode(s):
    s_lower = s.lower()
    for i,c in enumerate(le_season.classes_):
        if s_lower in c.lower() or c.lower() in s_lower:
            return i
    return int(df['season_encoded'].mode()[0])

devices = ['Air Conditioning','Fan','Lights']
user_state = {'Air Conditioning':ac_on,'Fan':fan_on,'Lights':light_on}

MAX_POWER = {'Air Conditioning':1500,'Fan':80,'Lights':10}

predicted = []
enc_season = season_encode(season_in)

for dev in devices:
    enc_dev = le_appliance.transform([dev])[0]
    data = pd.DataFrame({
        'appliance_encoded':[enc_dev],
        'outdoor_temp':[outdoor_temp],
        'season_encoded':[enc_season],
        'household_size':[household],
        'time_hour':[time_hour],
        'desired_temp':[desired_temp],
        'solar_generation':[solar_gen]
    })
    pred_kwh = rf.predict(data)[0]
    predW = pred_kwh * 1000
    predW = min(predW, MAX_POWER[dev])
    predicted.append(predW)

pred_map = {devices[i]:predicted[i] for i in range(3)}

traditional_load = 0.0
for d in devices:
    if user_state[d]:
        traditional_load += MAX_POWER[d]

demand = sum(pred_map[d] for d in devices if user_state[d])

if demand <= solar_gen:
    allocated = {d:(pred_map[d] if user_state[d] else 0) for d in devices}
    battery = solar_gen - sum(allocated.values())
else:
    frac = solar_gen / demand if demand > 0 else 0
    allocated = {d:(pred_map[d]*frac if user_state[d] else 0) for d in devices}
    battery = 0

df_out = pd.DataFrame({
    'Device':devices,
    'Predicted_Power_W':[pred_map[d] for d in devices],
    'Allocated_Power_W':[allocated[d] for d in devices]
})
df_out['Allocation_%'] = df_out['Allocated_Power_W']/solar_gen*100

print(df_out)
print("Traditional Load:", traditional_load)
print("Smart Load:", df_out['Allocated_Power_W'].sum())
print("Battery Storage:", battery)

plt.bar(['Traditional','Smart'],[traditional_load,df_out['Allocated_Power_W'].sum()])
plt.title("Traditional vs Smart Load")
plt.ylabel("Power (W)")
plt.show()

